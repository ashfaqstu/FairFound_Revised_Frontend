<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Human Review Dashboard - FairFound Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            indigo: {
              50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc',
              400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca',
              800: '#3730a3', 900: '#312e81'
            }
          }
        }
      }
    }
  </script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px; width: 16px;
      border-radius: 50%;
      background: #4f46e5;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 min-h-screen">
  <div id="app"></div>
  
  <script>
    const API_BASE_URL = 'https://fairfound-backend.onrender.com/api';
    
    // State
    let state = {
      loading: true,
      submitting: false,
      pendingReviews: [],
      selectedJobId: null,
      reviewData: null,
      decision: 'approved',
      humanConfidence: 0.8,
      accuracyRating: 4,
      relevanceRating: 4,
      actionabilityRating: 4,
      reviewNotes: '',
      submitSuccess: false,
      submitError: null,
      isDark: localStorage.getItem('theme') === 'dark'
    };

    // Apply dark mode
    if (state.isDark) document.documentElement.classList.add('dark');

    function getAuthHeaders() {
      const token = localStorage.getItem('access_token');
      return {
        'Content-Type': 'application/json',
        ...(token ? { Authorization: `Bearer ${token}` } : {})
      };
    }

    async function loadPendingReviews() {
      try {
        const response = await fetch(`${API_BASE_URL}/agents/human-review/`, {
          headers: getAuthHeaders()
        });
        if (response.ok) {
          const data = await response.json();
          state.pendingReviews = data.pending_reviews || [];
          if (!state.selectedJobId && state.pendingReviews.length > 0) {
            state.selectedJobId = state.pendingReviews[0].job_id;
            await loadReviewData(state.selectedJobId);
          }
        }
      } catch (err) {
        console.error('Error loading pending reviews:', err);
      }
      state.loading = false;
      render();
    }

    async function loadReviewData(jobId) {
      try {
        state.loading = true;
        render();
        const response = await fetch(`${API_BASE_URL}/agents/human-review/${jobId}/`, {
          headers: getAuthHeaders()
        });
        if (response.ok) {
          state.reviewData = await response.json();
          if (state.reviewData.existing_review) {
            state.decision = state.reviewData.existing_review.decision;
            state.humanConfidence = state.reviewData.existing_review.human_confidence || 0.8;
            state.accuracyRating = state.reviewData.existing_review.accuracy_rating || 4;
            state.relevanceRating = state.reviewData.existing_review.relevance_rating || 4;
            state.actionabilityRating = state.reviewData.existing_review.actionability_rating || 4;
            state.reviewNotes = state.reviewData.existing_review.review_notes || '';
          }
        }
      } catch (err) {
        console.error('Error loading review data:', err);
      }
      state.loading = false;
      render();
    }

    async function submitReview() {
      if (!state.selectedJobId) return;
      state.submitError = null;
      state.submitSuccess = false;
      state.submitting = true;
      render();

      try {
        const response = await fetch(`${API_BASE_URL}/agents/human-review/${state.selectedJobId}/submit/`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            decision: state.decision,
            human_confidence: state.humanConfidence,
            accuracy_rating: state.accuracyRating,
            relevance_rating: state.relevanceRating,
            actionability_rating: state.actionabilityRating,
            review_notes: state.reviewNotes
          })
        });

        if (response.ok) {
          state.submitSuccess = true;
          state.reviewNotes = '';
          loadPendingReviews();
          setTimeout(() => { state.submitSuccess = false; render(); }, 3000);
        } else {
          const errorData = await response.json().catch(() => ({}));
          state.submitError = errorData.error || errorData.detail || 'Failed to submit review';
        }
      } catch (err) {
        state.submitError = 'Network error. Please check your connection.';
      }
      state.submitting = false;
      render();
    }

    function getConfidenceColor(confidence) {
      if (confidence >= 0.8) return 'text-emerald-600 dark:text-emerald-400';
      if (confidence >= 0.6) return 'text-amber-600 dark:text-amber-400';
      return 'text-red-600 dark:text-red-400';
    }

    function toggleTheme() {
      state.isDark = !state.isDark;
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
      render();
    }

    function selectJob(jobId) {
      state.selectedJobId = jobId;
      loadReviewData(jobId);
    }

    function setDecision(d) { state.decision = d; render(); }
    function setConfidence(v) { state.humanConfidence = parseFloat(v); render(); }
    function setRating(type, v) { state[type] = v; render(); }
    function setNotes(v) { state.reviewNotes = v; }

    function renderStars(value, type) {
      return [1,2,3,4,5].map(star => `
        <button onclick="setRating('${type}', ${star})" class="p-0.5 transition-transform hover:scale-110">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="${star <= value ? '#fbbf24' : 'none'}" 
               stroke="${star <= value ? '#fbbf24' : '#94a3b8'}" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
      `).join('');
    }

    function render() {
      const app = document.getElementById('app');
      
      if (state.loading && !state.reviewData) {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center">
            <div class="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full"></div>
            <span class="ml-3 text-slate-600 dark:text-slate-400">Loading review data...</span>
          </div>
        `;
        return;
      }

      const rd = state.reviewData;
      const ai = rd?.ai_evaluation;

      app.innerHTML = `
        <div class="p-4 md:p-8 max-w-6xl mx-auto">
          <!-- Header -->
          <div class="mb-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-indigo-600 dark:text-indigo-400">
                  <path d="M12 2a8 8 0 0 0-8 8c0 4.4 8 12 8 12s8-7.6 8-12a8 8 0 0 0-8-8z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
              </div>
              <div>
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Human-in-the-Loop Review</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Admin Dashboard - Review AI Agent Evaluations</p>
              </div>
            </div>
            <button onclick="toggleTheme()" class="p-2 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400">
              ${state.isDark ? '‚òÄÔ∏è' : 'üåô'}
            </button>
          </div>

          <!-- Pending Reviews -->
          ${state.pendingReviews.length > 0 ? `
            <div class="mb-6 p-4 bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800">
              <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Select Evaluation to Review</h3>
              <div class="flex flex-wrap gap-2">
                ${state.pendingReviews.map(r => `
                  <button onclick="selectJob(${r.job_id})" class="px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                    state.selectedJobId === r.job_id
                      ? 'bg-indigo-600 text-white'
                      : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'
                  }">
                    <span>Job #${r.job_id}</span>
                    ${r.needs_review ? '<span class="ml-1 text-amber-500">‚ö†</span>' : ''}
                    <span class="ml-1 text-xs ${getConfidenceColor(r.ai_confidence)}">${(r.ai_confidence * 100).toFixed(0)}%</span>
                  </button>
                `).join('')}
              </div>
            </div>
          ` : ''}

          ${rd ? `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- AI Evaluation -->
              <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden">
                <div class="px-4 py-3 bg-slate-50 dark:bg-slate-800/50 flex items-center gap-2">
                  <span class="font-semibold text-slate-900 dark:text-white">ü§ñ AI Evaluation</span>
                  <span class="text-xs px-2 py-0.5 rounded-full ${
                    ai.confidence >= 0.8 ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300'
                    : 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300'
                  }">${(ai.confidence * 100).toFixed(0)}% confidence</span>
                </div>
                <div class="p-4 space-y-4">
                  ${ai.evaluation_metadata ? `
                    <div class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg text-xs flex flex-wrap gap-4">
                      <span>Iterations: ${ai.evaluation_metadata.iterations}</span>
                      <span>Type: ${ai.evaluation_type}</span>
                      <span class="${ai.evaluation_metadata.threshold_met ? 'text-emerald-600' : 'text-amber-600'}">
                        Threshold: ${ai.evaluation_metadata.threshold_met ? '‚úì Met' : '‚úó Not Met'}
                      </span>
                    </div>
                  ` : ''}
                  <div>
                    <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Summary</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">${ai.summary}</p>
                  </div>
                  <div>
                    <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Strengths</h4>
                    <ul class="space-y-1">
                      ${ai.strengths.map(s => `<li class="flex items-start gap-2 text-sm text-slate-600 dark:text-slate-400">
                        <span class="text-emerald-500">üëç</span> ${s}
                      </li>`).join('')}
                    </ul>
                  </div>
                  <div>
                    <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Areas for Improvement</h4>
                    <ul class="space-y-1">
                      ${ai.weaknesses.map(w => `<li class="flex items-start gap-2 text-sm text-slate-600 dark:text-slate-400">
                        <span class="text-amber-500">‚ö†</span> ${w}
                      </li>`).join('')}
                    </ul>
                  </div>
                  <div>
                    <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Recommendations</h4>
                    <ul class="space-y-1">
                      ${ai.recommendations.map((r, i) => `<li class="flex items-start gap-2 text-sm text-slate-600 dark:text-slate-400">
                        <span class="text-indigo-500 font-medium">${i+1}.</span> ${r}
                      </li>`).join('')}
                    </ul>
                  </div>
                  <div class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                    <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Scores</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                      <div>Overall: <span class="font-semibold">${(rd.scores.overall * 100).toFixed(1)}%</span></div>
                      <div>Tier: <span class="font-semibold">${rd.scores.tier}</span></div>
                      <div>Percentile: <span class="font-semibold">${rd.benchmark.percentile}th</span></div>
                      <div>Rate: <span class="font-semibold">$${ai.market_position.suggested_hourly_rate}/hr</span></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Human Review Form -->
              <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden">
                <div class="px-4 py-3 bg-slate-50 dark:bg-slate-800/50">
                  <span class="font-semibold text-slate-900 dark:text-white">üë§ Your Review</span>
                </div>
                <div class="p-4 space-y-5">
                  <!-- Decision -->
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Decision</label>
                    <div class="flex gap-2">
                      <button onclick="setDecision('approved')" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors ${
                        state.decision === 'approved' ? 'bg-emerald-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-emerald-50'
                      }">‚úì Approve</button>
                      <button onclick="setDecision('modified')" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors ${
                        state.decision === 'modified' ? 'bg-amber-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-amber-50'
                      }">‚úè Modify</button>
                      <button onclick="setDecision('rejected')" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors ${
                        state.decision === 'rejected' ? 'bg-red-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-red-50'
                      }">‚úó Reject</button>
                    </div>
                  </div>

                  <!-- Confidence -->
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Your Confidence</label>
                    <div class="flex items-center gap-4">
                      <input type="range" min="0" max="1" step="0.05" value="${state.humanConfidence}" 
                             onchange="setConfidence(this.value)" 
                             class="flex-1 h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer"/>
                      <span class="text-lg font-bold ${getConfidenceColor(state.humanConfidence)}">${(state.humanConfidence * 100).toFixed(0)}%</span>
                    </div>
                  </div>

                  <!-- Ratings -->
                  <div class="space-y-3">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Rate the AI Evaluation</label>
                    <div class="flex items-center gap-3">
                      <span class="text-sm text-slate-600 dark:text-slate-400 w-32">Accuracy</span>
                      <div class="flex gap-1">${renderStars(state.accuracyRating, 'accuracyRating')}</div>
                      <span class="text-sm text-slate-500">${state.accuracyRating}/5</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <span class="text-sm text-slate-600 dark:text-slate-400 w-32">Relevance</span>
                      <div class="flex gap-1">${renderStars(state.relevanceRating, 'relevanceRating')}</div>
                      <span class="text-sm text-slate-500">${state.relevanceRating}/5</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <span class="text-sm text-slate-600 dark:text-slate-400 w-32">Actionability</span>
                      <div class="flex gap-1">${renderStars(state.actionabilityRating, 'actionabilityRating')}</div>
                      <span class="text-sm text-slate-500">${state.actionabilityRating}/5</span>
                    </div>
                  </div>

                  <!-- Notes -->
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Review Notes</label>
                    <textarea onchange="setNotes(this.value)" placeholder="Add any notes about this evaluation..."
                              rows="3" class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-indigo-500 resize-none">${state.reviewNotes}</textarea>
                  </div>

                  <!-- Messages -->
                  ${state.submitSuccess ? `
                    <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg flex items-center gap-2">
                      <span class="text-emerald-600">‚úì</span>
                      <span class="text-sm text-emerald-700 dark:text-emerald-300 font-medium">Review submitted successfully!</span>
                    </div>
                  ` : ''}
                  ${state.submitError ? `
                    <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg flex items-center gap-2">
                      <span class="text-red-600">‚úó</span>
                      <span class="text-sm text-red-700 dark:text-red-300 font-medium">${state.submitError}</span>
                    </div>
                  ` : ''}

                  <!-- Submit -->
                  <button onclick="submitReview()" ${state.submitting || state.submitSuccess ? 'disabled' : ''}
                          class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2">
                    ${state.submitting ? '<span class="animate-spin">‚è≥</span> Submitting...' : state.submitSuccess ? '‚úì Submitted!' : '‚úì Submit Review'}
                  </button>
                </div>
              </div>
            </div>
          ` : `
            <div class="text-center py-12 bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800">
              <div class="text-4xl mb-4">üìä</div>
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">No Evaluations to Review</h3>
              <p class="text-slate-500 dark:text-slate-400">Complete a profile analysis first to review AI evaluations.</p>
            </div>
          `}
        </div>
      `;
    }

    // Check auth and load data
    const token = localStorage.getItem('access_token');
    if (!token) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center">
          <div class="text-center p-8 bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 max-w-md">
            <div class="text-4xl mb-4">üîí</div>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Admin Access Required</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-4">Please log in to access the Human Review Dashboard.</p>
            <a href="/" class="inline-block px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">Go to Login</a>
          </div>
        </div>
      `;
    } else {
      loadPendingReviews();
    }
  </script>
</body>
</html>